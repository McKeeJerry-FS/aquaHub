@page "/livestock"
@inject ILivestockService LivestockService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Livestock</PageTitle>

<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Livestock</h2>
        <a href="/livestock/add" class="btn btn-primary">
            + Add
        </a>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (livestock == null || !livestock.Any())
    {
        <div class="text-center py-5">
            <p class="text-muted">No livestock yet</p>
            <a href="/livestock/add" class="btn btn-primary">Add Livestock</a>
        </div>
    }
    else
    {
        @foreach (var group in livestock.GroupBy(l => l.TankId))
        {
            var tank = group.First().Tank;
            <div class="mb-4">
                <h5 class="text-muted mb-2">@tank?.Name</h5>
                <div class="list-group">
                    @foreach (var item in group)
                    {
                        <a href="/livestock/dashboard/@item.Id" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">@item.Name</h6>
                                    <small class="text-muted">
                                        @GetLivestockType(item)
                                        @if (!string.IsNullOrEmpty(item.Species))
                                        {
                                            <span> • @item.Species</span>
                                        }
                                        {
                                            <span> • @item.Species</span>
                                        }
                                    </small>
                                </div>
                                <i class="bi bi-chevron-right"></i>
                            </div>
                        </a>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Livestock>? livestock;
    private bool isLoading = true;
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (userId != null)
                {
                    livestock = await LivestockService.GetAllLivestockAsync(userId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading livestock: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetLivestockType(Livestock item)
    {
        return item switch
        {
            FreshwaterFish => "Freshwater Fish",
            SaltwaterFish => "Saltwater Fish",
            Coral c => $"Coral - {c.CoralType}",
            FreshwaterInvertebrate => "Freshwater Invertebrate",
            SaltwaterInvertebrate => "Saltwater Invertebrate",
            Plant => "Plant",
            _ => "Livestock"
        };
    }
}