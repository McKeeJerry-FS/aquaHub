@page "/equipment"
@inject IEquipmentService EquipmentService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Equipment</PageTitle>

<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Equipment</h2>
        <a href="/equipment/add" class="btn btn-primary">
            + Add
        </a>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (equipment == null || !equipment.Any())
    {
        <div class="text-center py-5">
            <p class="text-muted">No equipment yet</p>
            <a href="/equipment/add" class="btn btn-primary">Add Equipment</a>
        </div>
    }
    else
    {
        @foreach (var group in equipment.GroupBy(e => e.TankId))
        {
            var tank = group.First().Tank;
            <div class="mb-4">
                <h5 class="text-muted mb-2">@tank?.Name</h5>
                <div class="list-group">
                    @foreach (var item in group)
                    {
                        <a href="/equipment/dashboard/@item.Id" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">@item.Brand @item.Model</h6>
                                    <small class="text-muted">@GetEquipmentType(item)</small>
                                </div>
                                <i class="bi bi-chevron-right"></i>
                            </div>
                        </a>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Equipment>? equipment;
    private bool isLoading = true;
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (userId != null)
                {
                    equipment = await EquipmentService.GetAllEquipmentAsync(userId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading equipment: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetEquipmentType(Equipment item)
    {
        return item switch
        {
            Filter f => $"Filter - {f.Type}",
            Light => "Light",
            Heater h => $"Heater - {h.MinTemperature}-{h.MaxTemperature}°F",
            ProteinSkimmer => "Protein Skimmer",
            _ => "Equipment"
        };
    }
}