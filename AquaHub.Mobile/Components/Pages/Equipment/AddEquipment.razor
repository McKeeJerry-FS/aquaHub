@page "/tanks/{TankId:int}/equipment/add"
@using AquaHub.Shared.Services.Interfaces
@using AquaHub.Shared.Models
@using AquaHub.Shared.Models.Enums
@inject IEquipmentService EquipmentService
@inject ITankService TankService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Add Equipment</PageTitle>

<div class="container-fluid p-3">
    <div class="mb-3">
        <a href="@GetBackUrl()" class="btn btn-sm btn-outline-secondary">← Back</a>
    </div>

    <h3 class="mb-3">Add Equipment</h3>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Loading...</p>
        </div>
    }
    else if (tank == null)
    {
        <div class="alert alert-warning">Tank not found</div>
    }
    else
    {
        <div class="alert alert-info mb-3">
            <strong>Tank:</strong> @tank.Name
        </div>

        <EditForm Model="equipmentModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger" />

            <div class="mb-3">
                <label class="form-label">Equipment Type *</label>
                <select class="form-select" @bind="selectedEquipmentType">
                    <option value="">-- Select Type --</option>
                    <option value="Filter">Filter</option>
                    <option value="Light">Light</option>
                    <option value="Heater">Heater</option>
                    <option value="ProteinSkimmer">Protein Skimmer</option>
                </select>
            </div>

            @if (!string.IsNullOrEmpty(selectedEquipmentType))
            {
                <div class="mb-3">
                    <label class="form-label">Brand *</label>
                    <InputText class="form-control" @bind-Value="equipmentModel.Brand" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Model *</label>
                    <InputText class="form-control" @bind-Value="equipmentModel.Model" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Installed On *</label>
                    <InputDate class="form-control" @bind-Value="equipmentModel.InstalledOn" />
                </div>

                @if (selectedEquipmentType == "Filter")
                {
                    <hr class="my-3" />
                    <h5 class="mb-3">Filter Details</h5>

                    <div class="mb-3">
                        <label class="form-label">Filter Type *</label>
                        <InputSelect class="form-select" @bind-Value="filterModel.Type">
                            <option value="">-- Select --</option>
                            @foreach (var type in Enum.GetValues<FilterType>())
                            {
                                <option value="@type">@type</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Flow Rate (GPH)</label>
                        <InputNumber class="form-control" @bind-Value="filterModel.FlowRate" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Media</label>
                        <InputText class="form-control" @bind-Value="filterModel.Media" />
                    </div>
                }
                else if (selectedEquipmentType == "Light")
                {
                    <hr class="my-3" />
                    <h5 class="mb-3">Light Details</h5>

                    <div class="mb-3">
                        <label class="form-label">Wattage</label>
                        <InputNumber class="form-control" @bind-Value="lightModel.Wattage" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Spectrum</label>
                        <InputText class="form-control" @bind-Value="lightModel.Spectrum" placeholder="e.g., Full Spectrum, RGB" />
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="lightModel.IsDimmable" id="dimmable" />
                            <label class="form-check-label" for="dimmable">Dimmable</label>
                        </div>
                    </div>

                    @if (lightModel.IsDimmable)
                    {
                        <div class="mb-3">
                            <label class="form-label">Intensity (%)</label>
                            <InputNumber class="form-control" @bind-Value="lightModel.IntensityPercent" />
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Schedule</label>
                        <InputText class="form-control" @bind-Value="lightModel.Schedule" placeholder="e.g., 8am-8pm" />
                    </div>
                }
                else if (selectedEquipmentType == "Heater")
                {
                    <hr class="my-3" />
                    <h5 class="mb-3">Heater Details</h5>

                    <div class="mb-3">
                        <label class="form-label">Min Temperature (°F)</label>
                        <InputNumber class="form-control" @bind-Value="heaterModel.MinTemperature" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Max Temperature (°F)</label>
                        <InputNumber class="form-control" @bind-Value="heaterModel.MaxTemperature" />
                    </div>
                }
                else if (selectedEquipmentType == "ProteinSkimmer")
                {
                    <hr class="my-3" />
                    <h5 class="mb-3">Protein Skimmer Details</h5>

                    <div class="mb-3">
                        <label class="form-label">Capacity (gallons)</label>
                        <InputNumber class="form-control" @bind-Value="skimmerModel.Capacity" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <InputText class="form-control" @bind-Value="skimmerModel.Type" placeholder="e.g., In-Sump, Hang-On-Back" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Air Intake</label>
                        <InputNumber class="form-control" @bind-Value="skimmerModel.AirIntake" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cup Fill Level (%)</label>
                        <InputNumber class="form-control" @bind-Value="skimmerModel.CupFillLevel" />
                    </div>
                }
            }

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary"
                    disabled="@(string.IsNullOrEmpty(selectedEquipmentType) || isSubmitting)">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Add Equipment</span>
                    }
                </button>
                <a href="@GetBackUrl()" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter]
    public int TankId { get; set; }

    private Tank? tank;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string? userId;
    private string selectedEquipmentType = "";

    private EquipmentFormModel equipmentModel = new();
    private FilterFormModel filterModel = new();
    private LightFormModel lightModel = new();
    private HeaterFormModel heaterModel = new();
    private ProteinSkimmerFormModel skimmerModel = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (userId != null)
        {
            tank = await TankService.GetTankByIdAsync(TankId, userId);
            equipmentModel.InstalledOn = DateTime.Now;
        }

        isLoading = false;
    }

    private async Task HandleSubmit()
    {
        if (userId == null) return;

        try
        {
            isSubmitting = true;

            Equipment equipment = selectedEquipmentType switch
            {
                "Filter" => new Filter
                {
                    Brand = equipmentModel.Brand,
                    Model = equipmentModel.Model,
                    InstalledOn = equipmentModel.InstalledOn,
                    Type = filterModel.Type,
                    FlowRate = filterModel.FlowRate,
                    Media = filterModel.Media
                },
                "Light" => new Light
                {
                    Brand = equipmentModel.Brand,
                    Model = equipmentModel.Model,
                    InstalledOn = equipmentModel.InstalledOn,
                    Wattage = lightModel.Wattage,
                    Spectrum = lightModel.Spectrum,
                    IsDimmable = lightModel.IsDimmable,
                    IntensityPercent = lightModel.IntensityPercent,
                    Schedule = lightModel.Schedule
                },
                "Heater" => new Heater
                {
                    Brand = equipmentModel.Brand,
                    Model = equipmentModel.Model,
                    InstalledOn = equipmentModel.InstalledOn,
                    MinTemperature = heaterModel.MinTemperature,
                    MaxTemperature = heaterModel.MaxTemperature
                },
                "ProteinSkimmer" => new ProteinSkimmer
                {
                    Brand = equipmentModel.Brand,
                    Model = equipmentModel.Model,
                    InstalledOn = equipmentModel.InstalledOn,
                    Capacity = skimmerModel.Capacity,
                    Type = skimmerModel.Type,
                    AirIntake = skimmerModel.AirIntake,
                    CupFillLevel = skimmerModel.CupFillLevel
                },
                _ => throw new InvalidOperationException("Invalid equipment type")
            };

            await EquipmentService.CreateEquipmentAsync(equipment, TankId, userId);
            Navigation.NavigateTo($"/aquariums/{TankId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding equipment: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private string GetBackUrl()
    {
        return $"/aquariums/{TankId}";
    }

    public class EquipmentFormModel
    {
        public string Brand { get; set; } = string.Empty;
        public string Model { get; set; } = string.Empty;
        public DateTime InstalledOn { get; set; } = DateTime.Now;
    }

    public class FilterFormModel
    {
        public FilterType Type { get; set; }
        public double FlowRate { get; set; }
        public string Media { get; set; } = string.Empty;
    }

    public class LightFormModel
    {
        public double Wattage { get; set; }
        public string Spectrum { get; set; } = string.Empty;
        public bool IsDimmable { get; set; }
        public int IntensityPercent { get; set; } = 100;
        public string Schedule { get; set; } = string.Empty;
    }

    public class HeaterFormModel
    {
        public decimal MinTemperature { get; set; } = 76;
        public decimal MaxTemperature { get; set; } = 80;
    }

    public class ProteinSkimmerFormModel
    {
        public double Capacity { get; set; }
        public string Type { get; set; } = string.Empty;
        public int AirIntake { get; set; }
        public int CupFillLevel { get; set; }
    }
}