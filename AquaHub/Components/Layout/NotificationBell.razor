@using AquaHub.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@attribute [Authorize]

@if (isAuthenticated)
{
    <a href="/notifications" class="nav-link position-relative">
        <i class="bi bi-bell@(unreadCount > 0 ? "-fill" : "") me-1"></i>
        @if (unreadCount > 0)
        {
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                @(unreadCount > 99 ? "99+" : unreadCount.ToString())
            </span>
        }
    </a>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private bool isAuthenticated = false;
    private int unreadCount = 0;
    private Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        if (AuthState == null) return;

        var authState = await AuthState;
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                await UpdateUnreadCount(userId);

                // Set up a timer to refresh the count every 30 seconds
                timer = new Timer(async _ =>
                {
                    await UpdateUnreadCount(userId);
                    await InvokeAsync(StateHasChanged);
                }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
            }
        }
    }

    private async Task UpdateUnreadCount(string userId)
    {
        try
        {
            unreadCount = await NotificationService.GetUnreadCountAsync(userId);
        }
        catch
        {
            // Silently fail - don't break the UI
        }
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}