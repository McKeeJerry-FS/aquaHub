@page "/tanks/setup-wizard"
@using AquaHub.Shared.Services
@using AquaHub.Shared.Models
@using AquaHub.Shared.Models.Enums
@using AquaHub.Shared.Models.ViewModels
@using AquaHub.Shared.Services.Interfaces
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject ITankService TankService
@inject IFileUploadService FileUploadService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Aquarium Setup Wizard</PageTitle>

<div class="wizard-page">
    <!-- Header Section -->
    <div class="page-header">
        <div class="container">
            <div class="py-4">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="bi bi-stars me-2"></i>
                    Aquarium Setup Wizard
                </h1>
                <p class="mb-0">Let us guide you through setting up your new aquarium</p>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Progress Bar -->
                <div class="wizard-progress mb-4">
                    <div class="wizard-steps">
                        @for (int i = 1; i <= totalSteps; i++)
                        {
                            var stepNumber = i;
                            var isActive = stepNumber == currentStep;
                            var isCompleted = stepNumber < currentStep;
                            var stepClass = isActive ? "active" : isCompleted ? "completed" : "";

                            <div class="wizard-step @stepClass">
                                <div class="wizard-step-number">
                                    @if (isCompleted)
                                    {
                                        <i class="bi bi-check-lg"></i>
                                    }
                                    else
                                    {
                                        @stepNumber
                                    }
                                </div>
                                <div class="wizard-step-label">@GetStepLabel(stepNumber)</div>
                            </div>

                            @if (i < totalSteps)
                            {
                                <div class="wizard-step-connector @(isCompleted ? "completed" : "")"></div>
                            }
                        }
                    </div>
                </div>

                <!-- Wizard Form -->
                <EditForm Model="@model" OnValidSubmit="@HandleStepSubmit" FormName="wizardForm">
                    <DataAnnotationsValidator />

                    <div class="wizard-content">
                        @if (currentStep == 1)
                        {
                            <div class="wizard-step-content">
                                <h3 class="mb-4">
                                    <i class="bi bi-info-circle text-primary me-2"></i>
                                    Basic Information
                                </h3>

                                <div class="form-group">
                                    <label for="name" class="form-label">
                                        What would you like to name your aquarium? <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="name" @bind-Value="model.Name" class="form-control form-control-lg"
                                        placeholder="e.g., Living Room Reef, 75g Planted Tank" />
                                    <ValidationMessage For="@(() => model.Name)" class="text-danger small mt-1" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        What type of aquarium are you setting up? <span class="text-danger">*</span>
                                    </label>
                                    <div class="aquarium-type-grid">
                                        @foreach (var type in Enum.GetValues<AquariumType>())
                                        {
                                            var isSelected = model.Type == type;
                                            <div class="aquarium-type-card @(isSelected ? "selected" : "")"
                                                @onclick="() => SelectAquariumType(type)">
                                                <div class="type-icon">
                                                    <i class="bi bi-@GetTypeIcon(type)"></i>
                                                </div>
                                                <div class="type-name">@type</div>
                                                <div class="type-description">@GetTypeDescription(type)</div>
                                            </div>
                                        }
                                    </div>
                                    <ValidationMessage For="@(() => model.Type)" class="text-danger small mt-1" />
                                </div>
                            </div>
                        }
                        else if (currentStep == 2)
                        {
                            <div class="wizard-step-content">
                                <h3 class="mb-4">
                                    <i class="bi bi-rulers text-primary me-2"></i>
                                    Tank Specifications
                                </h3>

                                <div class="form-group">
                                    <label for="volume" class="form-label">
                                        What is the total volume of your tank? <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <InputNumber id="volume" @bind-Value="model.VolumeGallons"
                                            class="form-control form-control-lg" placeholder="e.g., 55" />
                                        <span class="input-group-text">gallons</span>
                                    </div>
                                    <ValidationMessage For="@(() => model.VolumeGallons)" class="text-danger small mt-1" />
                                </div>

                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Optional:</strong> Enter your tank dimensions for more accurate calculations
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="length" class="form-label">Length</label>
                                            <div class="input-group">
                                                <InputNumber id="length" @bind-Value="model.LengthInches"
                                                    class="form-control" placeholder="36" />
                                                <span class="input-group-text">inches</span>
                                            </div>
                                            <ValidationMessage For="@(() => model.LengthInches)"
                                                class="text-danger small mt-1" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="width" class="form-label">Width</label>
                                            <div class="input-group">
                                                <InputNumber id="width" @bind-Value="model.WidthInches" class="form-control"
                                                    placeholder="18" />
                                                <span class="input-group-text">inches</span>
                                            </div>
                                            <ValidationMessage For="@(() => model.WidthInches)"
                                                class="text-danger small mt-1" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="height" class="form-label">Height</label>
                                            <div class="input-group">
                                                <InputNumber id="height" @bind-Value="model.HeightInches"
                                                    class="form-control" placeholder="20" />
                                                <span class="input-group-text">inches</span>
                                            </div>
                                            <ValidationMessage For="@(() => model.HeightInches)"
                                                class="text-danger small mt-1" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else if (currentStep == 3)
                        {
                            <div class="wizard-step-content">
                                <h3 class="mb-4">
                                    <i class="bi bi-droplet-half text-primary me-2"></i>
                                    Water Parameters
                                </h3>

                                <p class="text-muted mb-4">
                                    Set your target water parameters for optimal @model.Type conditions
                                </p>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="temp" class="form-label">
                                                <i class="bi bi-thermometer-half me-2"></i>
                                                Target Temperature
                                            </label>
                                            <div class="input-group">
                                                <InputNumber id="temp" @bind-Value="model.TargetTemperature"
                                                    class="form-control" placeholder="@GetDefaultTemp()" />
                                                <span class="input-group-text">°F</span>
                                            </div>
                                            <ValidationMessage For="@(() => model.TargetTemperature)"
                                                class="text-danger small mt-1" />
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="ph" class="form-label">
                                                <i class="bi bi-droplet me-2"></i>
                                                Target pH
                                            </label>
                                            <InputNumber id="ph" @bind-Value="model.TargetPH" class="form-control"
                                                placeholder="@GetDefaultPH()" step="0.1" />
                                            <ValidationMessage For="@(() => model.TargetPH)"
                                                class="text-danger small mt-1" />
                                        </div>
                                    </div>
                                </div>

                                @if (model.IsReefOrSaltwater())
                                {
                                    <div class="alert alert-info mt-3">
                                        <i class="bi bi-water me-2"></i>
                                        <strong>Saltwater Parameters</strong>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="salinity" class="form-label">Salinity</label>
                                                <div class="input-group">
                                                    <InputNumber id="salinity" @bind-Value="model.TargetSalinity"
                                                        class="form-control" placeholder="35" />
                                                    <span class="input-group-text">ppt</span>
                                                </div>
                                                <ValidationMessage For="@(() => model.TargetSalinity)"
                                                    class="text-danger small mt-1" />
                                            </div>
                                        </div>
                                    </div>

                                    @if (model.Type == AquariumType.Reef)
                                    {
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="calcium" class="form-label">Calcium</label>
                                                    <div class="input-group">
                                                        <InputNumber id="calcium" @bind-Value="model.TargetCalcium"
                                                            class="form-control" placeholder="420" />
                                                        <span class="input-group-text">ppm</span>
                                                    </div>
                                                    <ValidationMessage For="@(() => model.TargetCalcium)"
                                                        class="text-danger small mt-1" />
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="alkalinity" class="form-label">Alkalinity</label>
                                                    <div class="input-group">
                                                        <InputNumber id="alkalinity" @bind-Value="model.TargetAlkalinity"
                                                            class="form-control" placeholder="8" />
                                                        <span class="input-group-text">dKH</span>
                                                    </div>
                                                    <ValidationMessage For="@(() => model.TargetAlkalinity)"
                                                        class="text-danger small mt-1" />
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }

                                @if (model.IsPlanted())
                                {
                                    <div class="alert alert-success mt-3">
                                        <i class="bi bi-flower1 me-2"></i>
                                        <strong>Planted Tank Parameters</strong>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="co2" class="form-label">CO₂ Level</label>
                                                <div class="input-group">
                                                    <InputNumber id="co2" @bind-Value="model.TargetCO2" class="form-control"
                                                        placeholder="30" />
                                                    <span class="input-group-text">ppm</span>
                                                </div>
                                                <ValidationMessage For="@(() => model.TargetCO2)"
                                                    class="text-danger small mt-1" />
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (currentStep == 4)
                        {
                            <div class="wizard-step-content">
                                <h3 class="mb-4">
                                    <i class="bi bi-gear-fill text-primary me-2"></i>
                                    Equipment Planning
                                </h3>

                                <p class="text-muted mb-4">
                                    Tell us what equipment you plan to use (we'll help you track it later)
                                </p>

                                <!-- Filter -->
                                <div class="equipment-section">
                                    <div class="form-check form-switch mb-3">
                                        <InputCheckbox id="hasFilter" @bind-Value="model.HasFilter"
                                            class="form-check-input" />
                                        <label class="form-check-label" for="hasFilter">
                                            <strong>Filtration System</strong>
                                        </label>
                                    </div>

                                    @if (model.HasFilter)
                                    {
                                        <div class="equipment-details">
                                            <label for="filterType" class="form-label">Filter Type</label>
                                            <InputSelect id="filterType" @bind-Value="model.FilterType" class="form-select">
                                                <option value="">-- Select Type --</option>
                                                @foreach (var type in Enum.GetValues<FilterType>())
                                                {
                                                    <option value="@type">@type</option>
                                                }
                                            </InputSelect>
                                        </div>
                                    }
                                </div>

                                <!-- Heater -->
                                <div class="equipment-section">
                                    <div class="form-check form-switch mb-3">
                                        <InputCheckbox id="hasHeater" @bind-Value="model.HasHeater"
                                            class="form-check-input" />
                                        <label class="form-check-label" for="hasHeater">
                                            <strong>Heater</strong>
                                        </label>
                                    </div>

                                    @if (model.HasHeater)
                                    {
                                        <div class="equipment-details">
                                            <label for="heaterWattage" class="form-label">Wattage</label>
                                            <div class="input-group">
                                                <InputNumber id="heaterWattage" @bind-Value="model.HeaterWattage"
                                                    class="form-control" placeholder="150" />
                                                <span class="input-group-text">watts</span>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <!-- Light -->
                                <div class="equipment-section">
                                    <div class="form-check form-switch mb-3">
                                        <InputCheckbox id="hasLight" @bind-Value="model.HasLight"
                                            class="form-check-input" />
                                        <label class="form-check-label" for="hasLight">
                                            <strong>Lighting</strong>
                                        </label>
                                    </div>

                                    @if (model.HasLight)
                                    {
                                        <div class="equipment-details">
                                            <label for="lightWattage" class="form-label">Wattage / PAR Rating</label>
                                            <div class="input-group">
                                                <InputNumber id="lightWattage" @bind-Value="model.LightWattage"
                                                    class="form-control" placeholder="100" />
                                                <span class="input-group-text">watts</span>
                                            </div>
                                        </div>
                                    }
                                </div>

                                @if (model.IsReefOrSaltwater())
                                {
                                    <!-- Protein Skimmer -->
                                    <div class="equipment-section">
                                        <div class="form-check form-switch">
                                            <InputCheckbox id="hasSkimmer" @bind-Value="model.HasProteinSkimmer"
                                                class="form-check-input" />
                                            <label class="form-check-label" for="hasSkimmer">
                                                <strong>Protein Skimmer</strong>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Wavemaker -->
                                    <div class="equipment-section">
                                        <div class="form-check form-switch">
                                            <InputCheckbox id="hasWavemaker" @bind-Value="model.HasWavemaker"
                                                class="form-check-input" />
                                            <label class="form-check-label" for="hasWavemaker">
                                                <strong>Wavemaker / Circulation Pump</strong>
                                            </label>
                                        </div>
                                    </div>
                                }

                                @if (model.IsPlanted())
                                {
                                    <!-- CO2 System -->
                                    <div class="equipment-section">
                                        <div class="form-check form-switch">
                                            <InputCheckbox id="hasCO2" @bind-Value="model.HasCO2System"
                                                class="form-check-input" />
                                            <label class="form-check-label" for="hasCO2">
                                                <strong>CO₂ Injection System</strong>
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (currentStep == 5)
                        {
                            <div class="wizard-step-content">
                                <h3 class="mb-4">
                                    <i class="bi bi-layers-fill text-primary me-2"></i>
                                    Substrate & Decor
                                </h3>

                                <div class="form-group">
                                    <label for="substrate" class="form-label">Substrate Type</label>
                                    <InputSelect id="substrate" @bind-Value="model.SubstrateType" class="form-select">
                                        <option value="">-- Select Substrate --</option>
                                        @foreach (var type in Enum.GetValues<AquariumSubstrate>())
                                        {
                                            <option value="@type">@GetSubstrateDisplay(type)</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => model.SubstrateType)" class="text-danger small mt-1" />
                                </div>

                                @if (model.SubstrateType != null)
                                {
                                    <div class="form-group">
                                        <label for="substratePounds" class="form-label">Substrate Amount</label>
                                        <div class="input-group">
                                            <InputNumber id="substratePounds" @bind-Value="model.SubstratePounds"
                                                class="form-control" placeholder="50" />
                                            <span class="input-group-text">lbs</span>
                                        </div>
                                        <small class="form-text text-muted">
                                            Recommended: @GetRecommendedSubstrate() lbs for your @model.VolumeGallons gallon
                                            tank
                                        </small>
                                        <ValidationMessage For="@(() => model.SubstratePounds)"
                                            class="text-danger small mt-1" />
                                    </div>
                                }

                                @if (model.IsReefOrSaltwater())
                                {
                                    <div class="equipment-section mt-4">
                                        <div class="form-check form-switch mb-3">
                                            <InputCheckbox id="hasLiveRock" @bind-Value="model.HasLiveRock"
                                                class="form-check-input" />
                                            <label class="form-check-label" for="hasLiveRock">
                                                <strong>Live Rock</strong>
                                            </label>
                                        </div>

                                        @if (model.HasLiveRock)
                                        {
                                            <div class="equipment-details">
                                                <label for="liveRockPounds" class="form-label">Live Rock Amount</label>
                                                <div class="input-group">
                                                    <InputNumber id="liveRockPounds" @bind-Value="model.LiveRockPounds"
                                                        class="form-control" placeholder="50" />
                                                    <span class="input-group-text">lbs</span>
                                                </div>
                                                <small class="form-text text-muted">
                                                    Recommended: 1-2 lbs per gallon (@model.VolumeGallons-@((model.VolumeGallons ??
                                                                                            0) * 2) lbs)
                                                </small>
                                                <ValidationMessage For="@(() => model.LiveRockPounds)"
                                                    class="text-danger small mt-1" />
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else if (currentStep == 6)
                        {
                            <div class="wizard-step-content">
                                <h3 class="mb-4">
                                    <i class="bi bi-calendar-check text-primary me-2"></i>
                                    Final Details
                                </h3>

                                <div class="form-group">
                                    <label for="startDate" class="form-label">
                                        When did/will you start this aquarium? <span class="text-danger">*</span>
                                    </label>
                                    <InputDate id="startDate" @bind-Value="model.StartDate" class="form-control" />
                                    <ValidationMessage For="@(() => model.StartDate)" class="text-danger small mt-1" />
                                </div>

                                <div class="form-group">
                                    <label for="image" class="form-label">
                                        <i class="bi bi-image text-primary me-2"></i>
                                        Upload a photo of your tank (optional)
                                    </label>
                                    <InputFile id="image" OnChange="HandleImageSelected" class="form-control"
                                        accept="image/*" />
                                    <small class="form-text text-muted">Max size: 5MB. Formats: JPG, PNG, GIF, WebP</small>
                                    @if (!string.IsNullOrEmpty(imagePreview))
                                    {
                                        <div class="image-preview-container mt-3">
                                            <img src="@imagePreview" alt="Preview" class="image-preview" />
                                        </div>
                                    }
                                </div>

                                <div class="form-group">
                                    <label for="notes" class="form-label">Additional Notes</label>
                                    <InputTextArea id="notes" @bind-Value="model.Notes" class="form-control" rows="4"
                                        placeholder="Any additional information about your setup..." />
                                    <ValidationMessage For="@(() => model.Notes)" class="text-danger small mt-1" />
                                </div>

                                <!-- Setup Summary -->
                                <div class="alert alert-success mt-4">
                                    <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>Setup Summary</h5>
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Tank Name:</strong> @model.Name</li>
                                        <li><strong>Type:</strong> @model.Type</li>
                                        <li><strong>Volume:</strong> @model.VolumeGallons gallons</li>
                                        @if (model.TargetTemperature.HasValue)
                                        {
                                            <li><strong>Target Temperature:</strong> @model.TargetTemperature°F</li>
                                        }
                                        @if (model.HasFilter)
                                        {
                                            <li><i class="bi bi-check-circle-fill text-success me-1"></i> Filtration System</li>
                                        }
                                        @if (model.HasHeater)
                                        {
                                            <li><i class="bi bi-check-circle-fill text-success me-1"></i> Heater</li>
                                        }
                                        @if (model.HasLight)
                                        {
                                            <li><i class="bi bi-check-circle-fill text-success me-1"></i> Lighting</li>
                                        }
                                        @if (model.SubstrateType.HasValue)
                                        {
                                            <li><strong>Substrate:</strong> @GetSubstrateDisplay(model.SubstrateType.Value)</li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="wizard-navigation">
                        @if (currentStep > 1)
                        {
                            <button type="button" class="btn btn-outline-secondary btn-lg" @onclick="PreviousStep">
                                <i class="bi bi-arrow-left me-2"></i>
                                Back
                            </button>
                        }

                        <div class="ms-auto d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger btn-lg" @onclick="CancelWizard">
                                Cancel
                            </button>

                            @if (currentStep < totalSteps)
                            {
                                <button type="button" class="btn btn-primary btn-lg" @onclick="NextStep">
                                    Next
                                    <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-success btn-lg" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-check-circle me-2"></i>
                                    Create Aquarium
                                </button>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @errorMessage
                        </div>
                    }
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private TankSetupWizardModel model = new();
    private int currentStep = 1;
    private int totalSteps = 6;
    private bool isSubmitting = false;
    private string? errorMessage;
    private string? imagePreview;
    private IBrowserFile? selectedImage;

    private void SelectAquariumType(AquariumType type)
    {
        model.Type = type;
    }

    private string GetTypeIcon(AquariumType type)
    {
        return type switch
        {
            AquariumType.Freshwater => "droplet",
            AquariumType.Saltwater => "water",
            AquariumType.Brackish => "droplet-half",
            AquariumType.Planted => "flower1",
            AquariumType.Reef => "stars",
            _ => "water"
        };
    }

    private string GetTypeDescription(AquariumType type)
    {
        return type switch
        {
            AquariumType.Freshwater => "Community fish, cold water species",
            AquariumType.Saltwater => "Marine fish only setup",
            AquariumType.Brackish => "Mix of salt and fresh water",
            AquariumType.Planted => "Lush aquatic plant environment",
            AquariumType.Reef => "Corals and marine invertebrates",
            _ => ""
        };
    }

    private string GetStepLabel(int step)
    {
        return step switch
        {
            1 => "Basic Info",
            2 => "Specifications",
            3 => "Water Parameters",
            4 => "Equipment",
            5 => "Substrate",
            6 => "Final Details",
            _ => ""
        };
    }

    private string GetDefaultTemp()
    {
        if (model.Type == null) return "78";
        return model.Type switch
        {
            AquariumType.Freshwater => "75",
            AquariumType.Planted => "76",
            AquariumType.Saltwater => "78",
            AquariumType.Reef => "78",
            AquariumType.Brackish => "77",
            _ => "78"
        };
    }

    private string GetDefaultPH()
    {
        if (model.Type == null) return "7.0";
        return model.Type switch
        {
            AquariumType.Freshwater => "7.0",
            AquariumType.Planted => "6.5",
            AquariumType.Saltwater => "8.2",
            AquariumType.Reef => "8.3",
            AquariumType.Brackish => "7.5",
            _ => "7.0"
        };
    }

    private string GetSubstrateDisplay(AquariumSubstrate substrate)
    {
        return substrate.ToString().Replace("_", " ");
    }

    private string GetRecommendedSubstrate()
    {
        if (!model.VolumeGallons.HasValue) return "0";
        // Roughly 1-1.5 lbs per gallon
        var recommended = Math.Round(model.VolumeGallons.Value * 1.25);
        return recommended.ToString();
    }

    private void NextStep()
    {
        if (ValidateCurrentStep())
        {
            if (currentStep < totalSteps)
            {
                currentStep++;
            }
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
            errorMessage = null;
        }
    }

    private bool ValidateCurrentStep()
    {
        errorMessage = null;

        switch (currentStep)
        {
            case 1:
                if (string.IsNullOrWhiteSpace(model.Name))
                {
                    errorMessage = "Please enter a name for your aquarium";
                    return false;
                }
                if (model.Type == null)
                {
                    errorMessage = "Please select an aquarium type";
                    return false;
                }
                break;

            case 2:
                if (!model.VolumeGallons.HasValue || model.VolumeGallons <= 0)
                {
                    errorMessage = "Please enter a valid volume";
                    return false;
                }
                break;
        }

        return true;
    }

    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        selectedImage = e.File;
        errorMessage = null;

        if (selectedImage != null)
        {
            if (selectedImage.Size > 5 * 1024 * 1024) // 5MB
            {
                errorMessage = "Image file size must be less than 5MB";
                selectedImage = null;
                imagePreview = null;
                return;
            }

            var allowedTypes = new[] { "image/jpeg", "image/png", "image/gif", "image/webp" };
            if (!allowedTypes.Contains(selectedImage.ContentType))
            {
                errorMessage = "Please upload a valid image file (JPG, PNG, GIF, or WebP)";
                selectedImage = null;
                imagePreview = null;
                return;
            }

            // Create preview
            var buffer = new byte[selectedImage.Size];
            await selectedImage.OpenReadStream(5 * 1024 * 1024).ReadAsync(buffer);
            imagePreview = $"data:{selectedImage.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private async Task HandleStepSubmit()
    {
        if (currentStep == totalSteps)
        {
            await SubmitForm();
        }
        else
        {
            NextStep();
        }
    }

    private async Task SubmitForm()
    {
        errorMessage = null;
        isSubmitting = true;

        try
        {
            // Upload image if selected
            if (selectedImage != null)
            {
                using var stream = selectedImage.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
                var imagePath = await FileUploadService.SaveImageAsync(stream, selectedImage.Name);
                model.ImagePath = imagePath;
            }

            // Get current user
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "Unable to identify user. Please log in again.";
                isSubmitting = false;
                return;
            }

            // Convert model to Tank
            var tank = model.ToTank();

            // Add tank and get the created tank with ID
            var createdTank = await TankService.CreateTankAsync(tank, userId);

            // TODO: In the future, we could also create equipment records, reminders, etc. based on wizard data

            // Navigate to tank dashboard
            Navigation.NavigateTo($"/tanks/{createdTank.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            isSubmitting = false;
        }
    }

    private void CancelWizard()
    {
        Navigation.NavigateTo("/tanks");
    }
}