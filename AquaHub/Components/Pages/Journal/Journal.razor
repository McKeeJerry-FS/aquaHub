@page "/tanks/{TankId:int}/journal"
@using AquaHub.Shared.Models
@using AquaHub.Services
@using AquaHub.Shared.Services.Interfaces
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject JournalService JournalService
@inject ITankService TankService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Tank Journal - @(tank?.Name ?? "Loading...")</PageTitle>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-3">Loading journal...</p>
    </div>
}
else if (tank == null)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> Tank not found.
    </div>
}
else
{
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5">
                <i class="bi bi-journal-text"></i> @tank.Name Journal
            </h1>
            <div class="d-flex gap-2">
                <a href="/tanks/@TankId/journal/add" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> New Entry
                </a>
                <a href="/tanks/dashboard/@TankId" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        @if (!entries.Any())
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No journal entries yet. Start recording your tank's journey!
            </div>
        }
        else
        {
            <!-- Timeline View -->
            <div class="timeline">
                @foreach (var entry in entries)
                {
                    <div class="timeline-item mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">@entry.Title</h5>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> @entry.Timestamp.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")
                                    </small>
                                </div>
                                <div class="btn-group" role="group">
                                    <a href="/tanks/@TankId/journal/edit/@entry.Id" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteEntry(entry.Id)">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                @if (!string.IsNullOrEmpty(entry.ImagePath))
                                {
                                    <img src="@entry.ImagePath" class="img-fluid mb-3 rounded" alt="Journal entry image" style="max-height: 300px; object-fit: cover;" />
                                }
                                <p class="card-text">@entry.Content</p>

                                @if (entry.MaintenanceLinks.Any() || entry.WaterTestLinks.Any())
                                {
                                    <hr />
                                    <div class="linked-records">
                                        <h6 class="text-muted mb-2">
                                            <i class="bi bi-link-45deg"></i> Linked Records
                                        </h6>
                                        
                                        @if (entry.MaintenanceLinks.Any())
                                        {
                                            <div class="mb-2">
                                                <strong>Maintenance:</strong>
                                                <ul class="list-unstyled ms-3">
                                                    @foreach (var link in entry.MaintenanceLinks)
                                                    {
                                                        <li>
                                                            <i class="bi bi-tools"></i>
                                                            @link.MaintenanceLog?.Type.ToString()
                                                            @if (link.MaintenanceLog?.WaterChangePercent.HasValue == true)
                                                            {
                                                                <text>(@link.MaintenanceLog.WaterChangePercent%)</text>
                                                            }
                                                            <small class="text-muted">
                                                                - @link.MaintenanceLog?.Timestamp.ToLocalTime().ToString("MMM dd, yyyy")
                                                            </small>
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        }

                                        @if (entry.WaterTestLinks.Any())
                                        {
                                            <div>
                                                <strong>Water Tests:</strong>
                                                <ul class="list-unstyled ms-3">
                                                    @foreach (var link in entry.WaterTestLinks)
                                                    {
                                                        <li>
                                                            <i class="bi bi-droplet-half"></i>
                                                            pH: @link.WaterTest?.PH?.ToString("F2"), 
                                                            Temp: @link.WaterTest?.Temperature?.ToString("F1")Â°F
                                                            <small class="text-muted">
                                                                - @link.WaterTest?.Timestamp.ToLocalTime().ToString("MMM dd, yyyy")
                                                            </small>
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public int TankId { get; set; }

    private Tank? tank;
    private List<JournalEntry> entries = new();
    private bool isLoading = true;
    private string userId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

                if (!string.IsNullOrEmpty(userId))
                {
                    tank = await TankService.GetTankByIdAsync(TankId, userId);
                    if (tank != null)
                    {
                        entries = await JournalService.GetJournalEntriesForTankAsync(TankId);
                    }
                }
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task DeleteEntry(int entryId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this journal entry?");
        if (confirmed)
        {
            var success = await JournalService.DeleteJournalEntryAsync(entryId);
            if (success)
            {
                entries.RemoveAll(e => e.Id == entryId);
                StateHasChanged();
            }
        }
    }
}

<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #007bff, #0056b3);
    }

    .timeline-item {
        position: relative;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -34px;
        top: 20px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #007bff;
        border: 2px solid white;
        box-shadow: 0 0 0 3px #007bff33;
    }

    .linked-records {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
    }
</style>
